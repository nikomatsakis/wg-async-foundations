<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Authoring the DistriData service - wg-async-foundations</title>
        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../welcome.html"><strong aria-hidden="true">1.</strong> üëãüèΩ Welcome</a></li><li class="chapter-item expanded "><a href="../../vision.html"><strong aria-hidden="true">2.</strong> üîÆ The vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision.html"><strong aria-hidden="true">2.1.</strong> ‚ùìHow to vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision/projects.html"><strong aria-hidden="true">2.1.1.</strong> Projects</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/status_quo.html"><strong aria-hidden="true">2.1.2.</strong> &quot;Status quo&quot; stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/shiny_future.html"><strong aria-hidden="true">2.1.3.</strong> &quot;Shiny future&quot; stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/comment.html"><strong aria-hidden="true">2.1.4.</strong> Commenting</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/awards.html"><strong aria-hidden="true">2.1.5.</strong> Awards</a></li></ol></li><li class="chapter-item "><a href="../../vision/how_it_feels.html"><strong aria-hidden="true">2.2.</strong> ü•∞ How using async Rust ought to feel</a></li><li class="chapter-item "><a href="../../vision/characters.html"><strong aria-hidden="true">2.3.</strong> üôã‚Äç‚ôÄÔ∏è Cast of characters</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/characters/alan.html"><strong aria-hidden="true">2.3.1.</strong> Alan</a></li><li class="chapter-item "><a href="../../vision/characters/grace.html"><strong aria-hidden="true">2.3.2.</strong> Grace</a></li><li class="chapter-item "><a href="../../vision/characters/niklaus.html"><strong aria-hidden="true">2.3.3.</strong> Niklaus</a></li><li class="chapter-item "><a href="../../vision/characters/barbara.html"><strong aria-hidden="true">2.3.4.</strong> Barbara</a></li></ol></li><li class="chapter-item "><a href="../../vision/projects.html"><strong aria-hidden="true">2.4.</strong> ‚ö° Projects</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/projects/template.html"><strong aria-hidden="true">2.4.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/projects/MonsterMesh.html"><strong aria-hidden="true">2.4.2.</strong> MonsterMesh (embedded sensors)</a></li><li class="chapter-item "><a href="../../vision/projects/DistriData.html"><strong aria-hidden="true">2.4.3.</strong> DistriData (Generic Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/TrafficMonitor.html"><strong aria-hidden="true">2.4.4.</strong> TrafficMonitor (Custom Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/YouBuy.html"><strong aria-hidden="true">2.4.5.</strong> YouBuy (Traditional Server Application)</a></li><li class="chapter-item "><a href="../../vision/projects/SLOW.html"><strong aria-hidden="true">2.4.6.</strong> SLOW (Protocol implementation)</a></li></ol></li><li class="chapter-item expanded "><a href="../../vision/status_quo.html"><strong aria-hidden="true">2.5.</strong> üò± Status quo</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/status_quo/problems.html"><strong aria-hidden="true">2.5.1.</strong> Problems</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/status_quo/problems/tmwdi.html"><strong aria-hidden="true">2.5.1.1.</strong> Too many ways to do it</a></li><li class="chapter-item "><a href="../../vision/status_quo/problems/footguns.html"><strong aria-hidden="true">2.5.1.2.</strong> Footguns</a></li><li class="chapter-item "><a href="../../vision/status_quo/problems/language_features.html"><strong aria-hidden="true">2.5.1.3.</strong> Missing language features</a></li><li class="chapter-item "><a href="../../vision/status_quo/problems/capabilities.html"><strong aria-hidden="true">2.5.1.4.</strong> Missing capabilities</a></li><li class="chapter-item "><a href="../../vision/status_quo/problems/tooling.html"><strong aria-hidden="true">2.5.1.5.</strong> Poor tooling support</a></li><li class="chapter-item "><a href="../../vision/status_quo/problems/testing.html"><strong aria-hidden="true">2.5.1.6.</strong> Writing tests is hard</a></li></ol></li><li class="chapter-item expanded "><a href="../../vision/status_quo/DistriData.html" class="active"><strong aria-hidden="true">2.5.2.</strong> Authoring the DistriData service</a></li><li class="chapter-item "><a href="../../vision/status_quo/slow.html"><strong aria-hidden="true">2.5.3.</strong> Creating a library for the SLOW protocol</a></li><li class="chapter-item "><a href="../../vision/status_quo/monster_mesh.html"><strong aria-hidden="true">2.5.4.</strong> Developing MonsterMesh, a system of embedded sensors</a></li><li class="chapter-item "><a href="../../vision/status_quo/base64.html"><strong aria-hidden="true">2.5.5.</strong> Implementing a base64 decoding library</a></li></ol></li><li class="chapter-item "><a href="../../vision/shiny_future.html"><strong aria-hidden="true">2.6.</strong> ‚ú® Shiny future</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/shiny_future/users_manual.html"><strong aria-hidden="true">2.6.1.</strong> üìö User's manual of the future</a></li></ol></li><li class="chapter-item "><a href="../../vision/roadmap.html"><strong aria-hidden="true">2.7.</strong> üìÖ Roadmap</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/roadmap/deliverable.html"><strong aria-hidden="true">2.7.1.</strong> Deliverable</a></li><li class="chapter-item "><a href="../../vision/roadmap/owner.html"><strong aria-hidden="true">2.7.2.</strong> Owner</a></li><li class="chapter-item "><a href="../../vision/roadmap/stages.html"><strong aria-hidden="true">2.7.3.</strong> Stages</a></li></ol></li><li class="chapter-item "><a href="../../vision/deliverables.html"><strong aria-hidden="true">2.8.</strong> ‚úÖ Deliverables</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/deliverables/async_fn.html"><strong aria-hidden="true">2.8.1.</strong> Async fn everywhere</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/deliverables/async_fn/async_fn_in_traits.html"><strong aria-hidden="true">2.8.1.1.</strong> Async fn in traits</a></li><li class="chapter-item "><a href="../../vision/deliverables/async_fn/impl_trait_in_traits.html"><strong aria-hidden="true">2.8.1.2.</strong> impl Trait in traits</a></li><li class="chapter-item "><a href="../../vision/deliverables/async_fn/tait.html"><strong aria-hidden="true">2.8.1.3.</strong> Type alias impl trait</a></li><li class="chapter-item "><a href="../../vision/deliverables/async_fn/gats.html"><strong aria-hidden="true">2.8.1.4.</strong> Generic associated types</a></li><li class="chapter-item "><a href="../../vision/deliverables/async_fn/dyn_async_trait.html"><strong aria-hidden="true">2.8.1.5.</strong> Dyn async trait</a></li><li class="chapter-item "><a href="../../vision/deliverables/async_fn/dyn_trait.html"><strong aria-hidden="true">2.8.1.6.</strong> Dyn trait</a></li><li class="chapter-item "><a href="../../vision/deliverables/async_fn/inline_async_fn.html"><strong aria-hidden="true">2.8.1.7.</strong> Inline async fn</a></li><li class="chapter-item "><a href="../../vision/deliverables/async_fn/async_drop.html"><strong aria-hidden="true">2.8.1.8.</strong> Async drop</a></li><li class="chapter-item "><a href="../../vision/deliverables/async_fn/async_closures.html"><strong aria-hidden="true">2.8.1.9.</strong> Async closures</a></li><li class="chapter-item "><a href="../../vision/deliverables/async_fn/async_tests.html"><strong aria-hidden="true">2.8.1.10.</strong> Async tests</a></li><li class="chapter-item "><a href="../../vision/deliverables/async_fn/recursive.html"><strong aria-hidden="true">2.8.1.11.</strong> Recursive async fn</a></li><li class="chapter-item "><a href="../../vision/deliverables/async_fn/boxable.html"><strong aria-hidden="true">2.8.1.12.</strong> Boxable async fn</a></li></ol></li><li class="chapter-item "><a href="../../vision/deliverables/borrowed_data_and_cancellation.html"><strong aria-hidden="true">2.8.2.</strong> Easy acccess to borrowed data, reliable cancellation</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/deliverables/borrowed_data_and_cancellation/capability.html"><strong aria-hidden="true">2.8.2.1.</strong> Capability</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/deliverables/borrowed_data_and_cancellation/capability/variant_async_trait.html"><strong aria-hidden="true">2.8.2.1.1.</strong> Variant: Async trait</a></li><li class="chapter-item "><a href="../../vision/deliverables/borrowed_data_and_cancellation/capability/variant_leak.html"><strong aria-hidden="true">2.8.2.1.2.</strong> Variant: Leak trait</a></li></ol></li><li class="chapter-item "><a href="../../vision/deliverables/borrowed_data_and_cancellation/scope_api.html"><strong aria-hidden="true">2.8.2.2.</strong> Scope API</a></li></ol></li><li class="chapter-item "><a href="../../vision/deliverables/async_iter.html"><strong aria-hidden="true">2.8.3.</strong> Flexible async iteration</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/deliverables/async_iter/traits.html"><strong aria-hidden="true">2.8.3.1.</strong> Traits</a></li><li class="chapter-item "><a href="../../vision/deliverables/async_iter/generators.html"><strong aria-hidden="true">2.8.3.2.</strong> Generators</a></li></ol></li><li class="chapter-item "><a href="../../vision/deliverables/portable.html"><strong aria-hidden="true">2.8.4.</strong> Portable across runtimes, easy to switch</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/deliverables/portable/async_read_write.html"><strong aria-hidden="true">2.8.4.1.</strong> Async read/write</a></li><li class="chapter-item "><a href="../../vision/deliverables/portable/async_iter.html"><strong aria-hidden="true">2.8.4.2.</strong> Async iteration</a></li><li class="chapter-item "><a href="../../vision/deliverables/portable/async_spawn.html"><strong aria-hidden="true">2.8.4.3.</strong> Async spawn, spawn-blocking</a></li><li class="chapter-item "><a href="../../vision/deliverables/portable/async_timer.html"><strong aria-hidden="true">2.8.4.4.</strong> Async timer</a></li><li class="chapter-item "><a href="../../vision/deliverables/portable/stdlib.html"><strong aria-hidden="true">2.8.4.5.</strong> Portable async functionality in stdlib</a></li></ol></li><li class="chapter-item "><a href="../../vision/deliverables/polish.html"><strong aria-hidden="true">2.8.5.</strong> Polish</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/deliverables/polish/lint_must_not_suspend.html"><strong aria-hidden="true">2.8.5.1.</strong> must_not_suspend lint</a></li><li class="chapter-item "><a href="../../vision/deliverables/polish/lint_blocking_fns.html"><strong aria-hidden="true">2.8.5.2.</strong> Lint blocking fns</a></li><li class="chapter-item "><a href="../../vision/deliverables/polish/lint_large_copies.html"><strong aria-hidden="true">2.8.5.3.</strong> Lint large copies</a></li><li class="chapter-item "><a href="../../vision/deliverables/polish/error_messages.html"><strong aria-hidden="true">2.8.5.4.</strong> Error messages for the most confusing scenarios</a></li><li class="chapter-item "><a href="../../vision/deliverables/polish/stacktraces.html"><strong aria-hidden="true">2.8.5.5.</strong> Stacktraces</a></li></ol></li><li class="chapter-item "><a href="../../vision/deliverables/tooling.html"><strong aria-hidden="true">2.8.6.</strong> Tooling</a></li><li class="chapter-item "><a href="../../vision/deliverables/testing.html"><strong aria-hidden="true">2.8.7.</strong> Testing</a></li><li class="chapter-item "><a href="../../vision/deliverables/documentation.html"><strong aria-hidden="true">2.8.8.</strong> Documentation</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/deliverables/documentation/async_book.html"><strong aria-hidden="true">2.8.8.1.</strong> Async book</a></li></ol></li><li class="chapter-item "><a href="../../vision/deliverables/threadsafe_portability.html"><strong aria-hidden="true">2.8.9.</strong> Threadsafe portability</a></li><li class="chapter-item "><a href="../../vision/deliverables/async_overloading.html"><strong aria-hidden="true">2.8.10.</strong> Async overloading</a></li></ol></li><li class="chapter-item "><a href="../../vision/unresolved_questions.html"><strong aria-hidden="true">2.9.</strong> ‚ùì Major unresolved questions or controversies</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/unresolved_questions/default_runtime.html"><strong aria-hidden="true">2.9.1.</strong> Default runtime?</a></li><li class="chapter-item "><a href="../../vision/unresolved_questions/async_fn.html"><strong aria-hidden="true">2.9.2.</strong> How to represent the AsyncFn traits?</a></li><li class="chapter-item "><a href="../../vision/unresolved_questions/cancellation.html"><strong aria-hidden="true">2.9.3.</strong> How best to integrate voluntary cancellation?</a></li><li class="chapter-item "><a href="../../vision/unresolved_questions/portable_without_generics.html"><strong aria-hidden="true">2.9.4.</strong> Extend stdlib to permit portable async without generics?</a></li><li class="chapter-item "><a href="../../vision/unresolved_questions/await_or_not.html"><strong aria-hidden="true">2.9.5.</strong> To await or not to await?</a></li></ol></li><li class="chapter-item "><a href="../../vision/submitted_stories.html"><strong aria-hidden="true">2.10.</strong> üíù Appendix: Submitted stories</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo.html"><strong aria-hidden="true">2.10.1.</strong> üò± Status quo</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/template.html"><strong aria-hidden="true">2.10.1.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_builds_a_task_scheduler.html"><strong aria-hidden="true">2.10.1.2.</strong> Alan builds a task scheduler</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_finds_database_drops_hard.html"><strong aria-hidden="true">2.10.1.3.</strong> Alan finds dropping database handles is hard</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_has_an_event_loop.html"><strong aria-hidden="true">2.10.1.4.</strong> Alan has an external event loop</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_hates_writing_a_stream.html"><strong aria-hidden="true">2.10.1.5.</strong> Alan hates writing a Stream</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_iteratively_regresses.html"><strong aria-hidden="true">2.10.1.6.</strong> Alan iteratively regresses performance</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_lost_the_world.html"><strong aria-hidden="true">2.10.1.7.</strong> Alan lost the world</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_misses_c_sharp_async.html"><strong aria-hidden="true">2.10.1.8.</strong> Alan misses C# async</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_needs_async_in_traits.html"><strong aria-hidden="true">2.10.1.9.</strong> Alan needs async in traits</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_runs_into_stack_trouble.html"><strong aria-hidden="true">2.10.1.10.</strong> Alan runs into stack trouble</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_started_trusting_the_rust_compiler_but_then_async.html"><strong aria-hidden="true">2.10.1.11.</strong> Alan started trusting the Rust compiler, but then... async</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_thinks_he_needs_async_locks.html"><strong aria-hidden="true">2.10.1.12.</strong> Alan thinks he needs async locks</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_tries_a_socket_sink.html"><strong aria-hidden="true">2.10.1.13.</strong> Alan tries using a socket Sink</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_tries_to_debug_a_hang.html"><strong aria-hidden="true">2.10.1.14.</strong> Alan tries to debug a hang</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_builds_a_cache.html"><strong aria-hidden="true">2.10.1.15.</strong> Alan tries to cache requests, which doesn't always happen</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_picks_web_server.html"><strong aria-hidden="true">2.10.1.16.</strong> Alan wants to migrate a web server to Rust</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/alan_writes_a_web_framework.html"><strong aria-hidden="true">2.10.1.17.</strong> Alan writes a web framework</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer.html"><strong aria-hidden="true">2.10.1.18.</strong> Alan extends an AWS service</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/writing_a_java_based_service.html"><strong aria-hidden="true">2.10.1.18.1.</strong> Writing a Java-based service at AWS</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/getting_started_with_rust.html"><strong aria-hidden="true">2.10.1.18.2.</strong> Getting started with Rust</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/coming_from_java.html"><strong aria-hidden="true">2.10.1.18.3.</strong> Coming from Java</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/ecosystem.html"><strong aria-hidden="true">2.10.1.18.4.</strong> Exploring the ecosystem</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/juggling_error_handling.html"><strong aria-hidden="true">2.10.1.18.5.</strong> Juggling error handling</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/failure_to_parallelize.html"><strong aria-hidden="true">2.10.1.18.6.</strong> Failure to parallelize</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/borrow_check_errors.html"><strong aria-hidden="true">2.10.1.18.7.</strong> Borrow check errors</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/solving_a_deadlock.html"><strong aria-hidden="true">2.10.1.18.8.</strong> Solving a deadlock</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/encountering_pin.html"><strong aria-hidden="true">2.10.1.18.9.</strong> Encoutering pin</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/figuring_out_the_best_option.html"><strong aria-hidden="true">2.10.1.18.10.</strong> Figuring out the best option</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/testing_the_service.html"><strong aria-hidden="true">2.10.1.18.11.</strong> Testing his service</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/missed_waker_leads_to_lost_performance.html"><strong aria-hidden="true">2.10.1.18.12.</strong> Missed Waker leads to lost performance</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/debugging_performance_problems.html"><strong aria-hidden="true">2.10.1.18.13.</strong> Debugging performance problems</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/aws_engineer/using_jni.html"><strong aria-hidden="true">2.10.1.18.14.</strong> Using JNI</a></li></ol></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_anguishes_over_http.html"><strong aria-hidden="true">2.10.1.19.</strong> Barbara anguishes over HTTP</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_wants_single_threaded_optimizations.html"><strong aria-hidden="true">2.10.1.20.</strong> Barbara awants single threaded optimizations</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_battles_buffered_streams.html"><strong aria-hidden="true">2.10.1.21.</strong> Barbara battles buffered streams</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_benchmarks_async_trait.html"><strong aria-hidden="true">2.10.1.22.</strong> Barbara begets backpressure and benchmarks async_trait</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_bridges_sync_and_async.html"><strong aria-hidden="true">2.10.1.23.</strong> Barbara bridges sync and async in perf.rust-lang.org</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_builds_an_async_executor.html"><strong aria-hidden="true">2.10.1.24.</strong> Barbara builds an async executor</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_carefully_dismisses_embedded_future.html"><strong aria-hidden="true">2.10.1.25.</strong> Barbara carefully dismisses embedded Future</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_compares_some_cpp_code.html"><strong aria-hidden="true">2.10.1.26.</strong> Barbara compares some C++ code</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_gets_burned_by_select.html"><strong aria-hidden="true">2.10.1.27.</strong> Barbara gets burned by select</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_makes_their_first_steps_into_async.html"><strong aria-hidden="true">2.10.1.28.</strong> Barbara makes their first foray into async</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_needs_async_helpers.html"><strong aria-hidden="true">2.10.1.29.</strong> Barbara needs Async Helpers</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_plays_with_async.html"><strong aria-hidden="true">2.10.1.30.</strong> Barbara plays with async</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_polls_a_mutex.html"><strong aria-hidden="true">2.10.1.31.</strong> Barbara polls a Mutex</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_tries_async_streams.html"><strong aria-hidden="true">2.10.1.32.</strong> Barbara tries async streams</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_tries_unix_socket.html"><strong aria-hidden="true">2.10.1.33.</strong> Barbara tries Unix socket</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_trims_a_stacktrace.html"><strong aria-hidden="true">2.10.1.34.</strong> Barbara trims a stacktrace</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_wants_async_insights.html"><strong aria-hidden="true">2.10.1.35.</strong> Barbara wants async insights</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_wants_to_use_ghostcell.html"><strong aria-hidden="true">2.10.1.36.</strong> Barbara wants to use GhostCell-like cell borrowing</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/barbara_writes_a_runtime_agnostic_lib.html"><strong aria-hidden="true">2.10.1.37.</strong> Barbara writes a runtime-agnostic library</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/grace_deploys_her_service.html"><strong aria-hidden="true">2.10.1.38.</strong> Grace deploys her service and hits obstacles</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/grace_tries_new_libraries.html"><strong aria-hidden="true">2.10.1.39.</strong> Grace tries new libraries</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/grace_waits_for_gdb_next.html"><strong aria-hidden="true">2.10.1.40.</strong> Grace waits for gdb next</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/grace_wants_to_integrate_c_api.html"><strong aria-hidden="true">2.10.1.41.</strong> Grace wants to integrate a C-API</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/grace_writes_a_new_fb_service.html"><strong aria-hidden="true">2.10.1.42.</strong> Grace writes a new Facebook service</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/niklaus_simulates_hydrodynamics.html"><strong aria-hidden="true">2.10.1.43.</strong> Niklaus builds a hydrodynamics simulator</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/status_quo/niklaus_wants_to_share_knowledge.html"><strong aria-hidden="true">2.10.1.44.</strong> Niklaus wants to share knowledge</a></li></ol></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future.html"><strong aria-hidden="true">2.10.2.</strong> ‚ú® Shiny future</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/template.html"><strong aria-hidden="true">2.10.2.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/alan_learns_async_on_his_own.html"><strong aria-hidden="true">2.10.2.2.</strong> Alan learns async on his own</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/alans_trust_in_the_compiler_is_rewarded.html"><strong aria-hidden="true">2.10.2.3.</strong> Alan's trust in the compiler is rewarded</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/alan_switches_runtimes.html"><strong aria-hidden="true">2.10.2.4.</strong> Alan switches runtimes</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/barbara_appreciates_performance_tools.html"><strong aria-hidden="true">2.10.2.5.</strong> Barbara appreciates great performance analysis tools</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/barbara_enjoys_an_async_sandwich.html"><strong aria-hidden="true">2.10.2.6.</strong> Barbara enjoys an async sandwich</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/barbara_makes_a_wish.html"><strong aria-hidden="true">2.10.2.7.</strong> Barbara makes a wish</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/barbara_wants_async_rw.html"><strong aria-hidden="true">2.10.2.8.</strong> Barbara wants async read write</a></li><li class="chapter-item "><a href="../../vision/submitted_stories/shiny_future/barbara_wants_async_tracing.html"><strong aria-hidden="true">2.10.2.9.</strong> Barbara wants async tracing</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><a href="../../triage.html"><strong aria-hidden="true">3.</strong> üîç Triage meetings</a></li><li class="chapter-item "><a href="../../design_docs.html"><strong aria-hidden="true">4.</strong> üî¨ Design docs</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/yield_safe.html"><strong aria-hidden="true">4.1.</strong> ‚ö†Ô∏è Yield-safe lint</a></li><li class="chapter-item "><a href="../../design_docs/stream.html"><strong aria-hidden="true">4.2.</strong> ‚òî Stream trait</a></li><li class="chapter-item "><a href="../../design_docs/generator_syntax.html"><strong aria-hidden="true">4.3.</strong> ‚ö° Generator syntax</a></li><li class="chapter-item "><a href="../../design_docs/async_read_write.html"><strong aria-hidden="true">4.4.</strong> üìù AsyncRead, AsyncWrite traits</a></li><li class="chapter-item "><a href="../../design_docs/async_fn_in_traits.html"><strong aria-hidden="true">4.5.</strong> üß¨ Async fn in traits</a></li><li class="chapter-item "><a href="../../design_docs/mutex.html"><strong aria-hidden="true">4.6.</strong> üîí Mutex (future-aware)</a></li><li class="chapter-item "><a href="../../design_docs/channels.html"><strong aria-hidden="true">4.7.</strong> üì∫ Async aware channels</a></li><li class="chapter-item "><a href="../../design_docs/async_closures.html"><strong aria-hidden="true">4.8.</strong> üì¶ Async closures</a></li><li class="chapter-item "><a href="../../design_docs/join.html"><strong aria-hidden="true">4.9.</strong> ü§ù Join combinator</a></li><li class="chapter-item "><a href="../../design_docs/select.html"><strong aria-hidden="true">4.10.</strong> ü§∑‚Äç‚ôÄÔ∏è Select combinator</a></li><li class="chapter-item "><a href="../../design_docs/sink_trait.html"><strong aria-hidden="true">4.11.</strong> üö∞ Sink trait</a></li><li class="chapter-item "><a href="../../design_docs/async_main.html"><strong aria-hidden="true">4.12.</strong> üéá Async main</a></li><li class="chapter-item "><a href="../../design_docs/async_drop.html"><strong aria-hidden="true">4.13.</strong> üóëÔ∏è Async drop</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/async_lifecycle.html"><strong aria-hidden="true">4.13.1.</strong> ‚ôªÔ∏è Async lifecycle</a></li></ol></li><li class="chapter-item "><a href="../../design_docs/completion_based_futures.html"><strong aria-hidden="true">4.14.</strong> ‚è≥ Completion-based futures</a></li></ol></li><li class="chapter-item "><a href="../../conversations.html"><strong aria-hidden="true">5.</strong> üí¨ Conversations</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../conversations/2021-02-12-Twitter-Thread.html"><strong aria-hidden="true">5.1.</strong> üê¶ 2021-02-12 Twitter thread</a></li></ol></li><li class="chapter-item "><a href="../../acknowledgments.html"><strong aria-hidden="true">6.</strong> ‚ù§Ô∏è Acknowledgments</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">wg-async-foundations</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/wg-async-foundations" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="-status-quo-distridata"><a class="header" href="#-status-quo-distridata">üò± Status quo: DistriData</a></h1>
<p>This is the story of <a href="../characters.html">Alan, Barbara, Grace, and Niklaus</a> (ABG and N, hereafter) as they work on <a href="../projects/DistriData.html">DistriData</a>. It shows the various problems they hit in getting started and how they work around them today.</p>
<h2 id="background-building-services-in-java-and-c"><a class="header" href="#background-building-services-in-java-and-c">Background: building services in Java and C++</a></h2>
<p>Alan and Grace are starting a new project, DistriData. As so often happens, they're trying to move on a tight deadline and to stand up the new service as quickly as they can.</p>
<p>Most services at the company are implemented in Java and have a fairly well supported set of tools. Getting started on a new service can be done in minutes simply by creating a description of your service API in an IDL language and generating the support code from a template. This service comes pre-packaged with a lot of useful metrics and logic for things like dropped and cancelling dead connections. Unfortunately, using Java has its downsides, too. The services can consume a lot of memory, and while most requests complete very quickly, the &quot;tail latencies&quot; for the slowest requests can be very long.</p>
<p>For DistriData, performance is absolutely crucial, and so Alan and Grace are investigating alternatives to Java. They're both experienced engineers at the company, but Alan has only worked on Java services befre. Grace has built a number of C++-based services in the past, but she has had mixed experiences. Performance and resource usage is great, but the maintenance burden is high, and she has been through her share of fire drills related to security vulnerabilities. She's also seen that it's really hard to onboard people onto those services, since every patch potentially introduces so many serious problems. </p>
<p>Alan and Grace have heard that a lot of people in their company are starting to adopt Rust, and it seems like a promising option. It offers the kind of performance they need, but the type system implies that they won't have to worry about crashes and bugs. This makes Alan feel a bit better: he was nervous about hacking on a C++ system and what kinds of weird problems he might cause without realizing it!</p>
<h2 id="finding-a-rust-ide"><a class="header" href="#finding-a-rust-ide">Finding a Rust IDE</a></h2>
<p>Getting started with Rust is a bit different than what Alan and Grace are used to. There's not much infrastructure. They still define their service interface using the same modeling language, but there is no tooling to generate a server from it, they'll have to do that themselves. Before that, though, they have to learn the basics of the language.</p>
<p>Naturally, the very first thing that Alan does is to tweak his IDE setup. He's accustomed to IntelliJ from his Java work, and he's happy to learn that IntelliJ has support for Rust too. Still, as he plays around with Rust code, he realizes that IntelliJ's support is not nearly at the level of Java. Autocomplete often gets confused. For example, when there are two traits with the same name but coming from different crates, IntelliJ often picks the wrong one. It also has trouble with macros. Still, it works well enough.</p>
<p>Grace, meanwhile, decides to use VSCode. She goes to the Extensions list and finds an extension for the RLS. She installs it but finds that it has quite simple support. Asking around on the <code>#rust</code> Slack channel, she learns that most people are using the rust-analyzer plugin. Installing that, she finds the experience is much better. &quot;Why isn't this the default&quot;, she wonders.</p>
<h2 id="alan-learns-rust-basics"><a class="header" href="#alan-learns-rust-basics">Alan learns Rust basics</a></h2>
<p>It's time for Alan to buckle down and learn Rust. He starts by trying to read the Rust book. He spends a week reading it, and gets through a lot of chapters, but he hasn't actually written any code yet. Some of the concepts are feeling pretty confused.</p>
<p>In the past, learning Kotlin, he used the <a href="https://kotlinlang.org/docs/koans.html">Kotlin Koans</a> and found that it was really fun to work with examples. For Rust, he decides to try some of the projects from <a href="https://leetcode.com/">leetcode.com</a>. Unfortunately, uing leetcode examples turns out to be a horrible idea. The examples are all data structure questions, and he is finding them very difficult. which he has heard is the hardest thing to do in Rust, and of course it's also the thing you do the least in real life. One particular question involves a tree and merging linked lists; searching around he finds the question on leetcode is <a href="https://leetcode.com/problems/merge-two-sorted-lists/discuss/212315/Rust-solution-%22why-it%27s-so-damn-hard-to-implement%22">&quot;Why is it so damn hard to implement?&quot;</a> He is starting to feel frustrated and to question to decision to use Rust in the first place. (The answer does, however, point him at <a href="https://rust-unofficial.github.io/too-many-lists/">&quot;Learning Rust using way too many linked lists&quot;</a>, which he reads and really enjoys.)</p>
<p>Adapting from Java proves to be trickier than Alan expected. Even simple things, like a <em>variable</em>, seems to work differently in Rust. In the JVM, a variable is always a pointer. You can have two variables that refer to the same object, but you can't have other people changing your variables to point to fresh values. Alan can tell from the learning materials that Rust variables are different, but he doesn't really get what they <em>are</em>. </p>
<p>Eventually, things start to fall in place. After working through more programs, Alan starts to get an intuition for what a variable in Rust actually was, and the relationship between borrowing and pointers. Watching some of <a href="https://www.youtube.com/c/jongjengset">Jon Ghengset's videos</a>, he starts to understand how interior mutablity works. Soon he has some prototype projects working, and he feels ready to try and prototype the service itself.</p>
<h2 id="grace-learns-rust-basics"><a class="header" href="#grace-learns-rust-basics">Grace learns Rust basics</a></h2>
<p>Grace's path to Rust is a bit different. She's familiar with C++, so concepts like a variable come natural to her, but there are other things about Rust that are confusing. XX talk to some C++ folk to get a better idea what these are?</p>
<h2 id="they-start-to-build-something-in-async-rust"><a class="header" href="#they-start-to-build-something-in-async-rust">They start to build something in async Rust</a></h2>
<p>Now that Alan and Grace understand the basics of Rust, they decide to try and build something in Async Rust. The Rust book doesn't seem to have any coverage for async I/O, so they google for &quot;async Rust book&quot;. They come to a book called &quot;Asynchronous Programming in Rust&quot; that looks official. It has a promising intro, but it quickly dives into all kinds of details they don't really understand.</p>
<p>Frustrated, they ask in the #rust channel on the company slack. Barbara, a more experienced Rust user, explains how Rust offers a number of runtimes, many of which are tailored to specific purposes. She advises them that most people in the company are using tokio, which is a good &quot;general purpose&quot; runtime. They decide to try that out.</p>
<p>Reading the tokio website, they find it has a nice tutorial. &quot;This is great, it'd be nice if the official async book were more like this&quot;, they think. Using the tutorial, they learn a lot of the core concepts of tokio, and construct a simple redis server. They're feeling good.</p>
<h2 id="exploring-the-ecosystem"><a class="header" href="#exploring-the-ecosystem">Exploring the ecosystem</a></h2>
<p>At its heart, the DistriData service is fairly simple. It accepts HTTP requests with data and then forwards those requests to various backend services to ensure the data is replicated and safe. In Java, their &quot;base service&quot; setup would include an HTTP server, but in Rust they have to roll their own. The tokio tutorial, unfortunately, didn't cover anything like this. Alan and Grace start asking in #rust for advice. They are directed to hyper.</p>
<p>They find this pattern of &quot;lots of choices&quot; repeats as they work on other parts of the service. For each simple thing, there seem to be a number of differet variations: multiple lock implementations, muliple traits for interop, and so forth. Even though they've committed to tokio, they often find references to these other libraries online, which is sometimes confusing.</p>
<p>The &quot;choices&quot; question extends beyond async, as well. It's often hard to evaluate which of the various crates in crates.io is the best. For example, Alan spent some time evaluating crates that do md5 hashing, for example, and found tons of choices. He does some quick performance testing and finds huge differences: openssl seems to be the fastest, so he takes that, but he is worried he may have missed some crates.</p>
<h2 id="getting-error-handling-right-is-tricky"><a class="header" href="#getting-error-handling-right-is-tricky">Getting error handling right is tricky</a></h2>
<p>As they make progress on the server, they are feeling increasingly confident in Rust, but some things still seem surprisingly challenging. For example, one day Alan is writing the core loop of DistriData which distributes data. The way it works is that the data is broken into &quot;shards&quot; and each shard has a number of &quot;chunks&quot;. He is connected to various backend storage hosts via HTTP, and he needs to send each chunk out to all of them. </p>
<p>Alan starts by writing some code that uses <a href="https://docs.rs/hyper/0.14.7/hyper/body/struct.Body.html#method.channel"><code>hyper::body::channel</code></a> to generate a pair of a channel where data can be sent and a resulting HTTP body. He then creates a future for each of those HTTP bodies that will send it to the appropriate host once it is complete. He wants those sends to be executing in the background as the data arrives on the channel, so he creates a <a href="https://docs.rs/futures/0.3.14/futures/stream/struct.FuturesOrdered.html"><code>FuturesUnordered</code></a> to host them:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut host_senders: Vec&lt;hyper::body::Sender&gt; = vec![];
let mut host_futures = FuturesUnordered::new();
for host in hosts {
    let (sender, body) = hyper::body::Body::channel();
    host_senders.push(sender);
    host_futures.push(create_future_to_send_request(body));
}
<span class="boring">}
</span></code></pre></pre>
<p>Next, he wants to iterate through each of the shards. For each shard, he will send each chunk to each of the hosts:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut shards = /* generate a stream of Shards */;
while let Some(chunks) = shards.next().await {
    let chunk_futures = chunks
        .into_iter()
        .zip(&amp;mut host_senders)
        .map(|(chunk, sender)| sender.send_data(chunk)?);

    futures::join_all(chunk_futures).await;
}
<span class="boring">}
</span></code></pre></pre>
<p>The last line is giving him a bit of trouble. Each of the requests to send the futures could fail, and he would like to propagate that failure. He's used to writing <code>?</code> to propagate an error, but when he puts <code>?</code> in <code>sender.send_data</code> he gets an error:</p>
<pre><code>error[E0277]: the `?` operator can only be applied to values that implement `Try`
  --&gt; src/lib.rs:18:40
   |
18 |                 .map(|(chunk, sender)| sender.send_data(chunk)?);
   |                                        ^^^^^^^^^^^^^^^^^^^^^^^^ the `?` operator cannot be applied to type `impl futures::Future`
   |
   = help: the trait `Try` is not implemented for `impl futures::Future`
   = note: required by `into_result`
</code></pre>
<p>&quot;Right,&quot; Alan thinks, &quot;I need to await the future.&quot; He tries to move the <code>?</code> to the result of <code>join_all</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut shards = /* generate a stream of Shards */;
while let Some(chunks) = shards.next().await {
    let chunk_futures = chunks
        .into_iter()
        .zip(&amp;mut host_senders)
        .map(|(chunk, sender)| sender.send_data(chunk));

    futures::join_all(chunk_futures).await?;
}
<span class="boring">}
</span></code></pre></pre>
<p>But now he sees:</p>
<pre><code>error[E0277]: the `?` operator can only be applied to values that implement `Try`
  --&gt; src/lib.rs:20:9
   |
20 |         join_all(chunk_futures).await?;  
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the `?` operator cannot be applied to type `Vec&lt;std::result::Result&lt;(), hyper::Error&gt;&gt;`
   |
   = help: the trait `Try` is not implemented for `Vec&lt;std::result::Result&lt;(), hyper::Error&gt;&gt;`
   = note: required by `into_result`
</code></pre>
<p>&quot;Ah,&quot; he says, &quot;of course, I have a vector of potential errors, not a single error.&quot; He remembers seeing a trick for this somewhere. Searching the web, he finds the example. It takes him a little bit to get the type annotations just right, but he finally lands on:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>while let Some(chunks) = shards.next().await {
    let chunk_futures = chunks
        .into_iter()
        .zip(&amp;mut host_senders)
        .map(|(chunk, sender)| sender.send_data(chunk));

    join_all(chunk_futures)
        .await
        .into_iter()
        .collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;()?;
}
<span class="boring">}
</span></code></pre></pre>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=aa16c1901a13603df7cd050ecc47e61e">playground</a></p>
<p>The loop now works: it sends each chunk from each shard to each host, and propagates errors in a reasonable way. The last step is to write for those writes to complete. To do this, he has until all the data has actually been sent, keeping in mind that there could be errors in these sends too. He writes a quick loop to iterate over the stream of sending futures <code>host_futures</code> that he created earlier:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>loop {
    match host_futures.next().await {
        Some(Ok(response)) =&gt; handle_response(response)?,
        Some(Err(e)) =&gt; return Err(e)?,
        None =&gt; return Ok(()),
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>It takes him a few tries to get this loop right too. The <code>Some(Err(e))</code> case in particular is a bit finnicky. He tried to just <code>return Err(e)</code> but it gave him an error, because the of <code>e</code> didn't match the more generic <code>Box&lt;dyn Error&gt;</code> type that his function returns. He remembered that the <code>?</code> operator performs some interconversion, though, and that you can do <code>Err(e)?</code> to workaround this particular problem.</p>
<p>He surveys the final function he has built, feeling a sense of satisfaction that he got it to work. Still, he can't help but think that this was an awful lot of work just to propagate errors. Plus, he knows from experience that the errors in Rust are often less useful for finding problems than the ones he used to get in Java. Rust errors don't capture backtraces, for example. He tried to add some code to capture backtraces at one point but it seemed really slow, taking 20ms or so to snag a backtrace, and he knew that would be a problem in production.</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Prepare the outgoing HTTP requests to each host:
let mut host_senders: Vec&lt;hyper::body::Sender&gt; = vec![];
let mut host_futures = FuturesUnordered::new();
for host in hosts {
    let (sender, body) = hyper::body::Body::channel();
    host_senders.push(sender);
    host_futures.push(create_future_to_send_request(body));
}

// Send each chunk from each shared to each host:
while let Some(chunks) = shards.next().await {
    let chunk_futures = chunks
        .into_iter()
        .zip(&amp;mut host_senders)
        .map(|(chunk, sender)| sender.send_data(chunk));

    join_all(chunk_futures)
        .await
        .into_iter()
        .collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;()?;
}

// Wait for all HTTP requests to complete, aborting on error:
loop {
    match host_futures.next().await {
        Some(Ok(response)) =&gt; handle_response(response)?,
        Some(Err(e)) =&gt; return Err(e)?,
        None =&gt; return Ok(()),
    }
}
<span class="boring">}
</span></code></pre></pre>
<h2 id="trying-to-parallelize-a-loop"><a class="header" href="#trying-to-parallelize-a-loop">Trying to parallelize a loop</a></h2>
<p>As Alan reads the loop he just built, he realizes that he ought to be able to process each shared independently. He decides to try spawning the tasks in parallel. He starts by trying to create a stream that spawns out tasks:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Send each chunk from each shared to each host:
while let Some(chunks) = shards.next().await {
    tokio::spawn(async move {
        let chunk_futures = chunks
            .into_iter()
            .zip(&amp;mut host_senders)
            .map(|(chunk, sender)| sender.send_data(chunk));

        join_all(chunk_futures)
            .await
            .into_iter()
            .collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;()?;
    })
}
<span class="boring">}
</span></code></pre></pre>
<p>But this is giving him errors about the <code>?</code> operator again:</p>
<pre><code>error[E0277]: the `?` operator can only be used in an async block that returns `Result` or `Option` (or another type that implements `Try`)
  --&gt; src/lib.rs:21:13
   |
15 |            tokio::spawn(async move {
   |   _________________________________-
16 |  |             let chunk_futures = chunks
17 |  |                 .into_iter()
18 |  |                 .zip(&amp;mut host_senders)
...   |
21 | /|             join_all(chunk_futures)
22 | ||                 .await
23 | ||                 .into_iter()
24 | ||                 .collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;()?;
   | ||________________________________________________^ cannot use the `?` operator in an async block that returns `()`
25 |  |         });
   |  |_________- this function should return `Result` or `Option` to accept `?`
   |
   = help: the trait `Try` is not implemented for `()`
   = note: required by `from_error`
</code></pre>
<p>Annoyed, he decides to convert those to <code>unwrap</code> calls temporarily (which will just abort the process on error) just to see if he can get something working:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    while let Some(chunks) = shards.next().await {
        tokio::spawn(async move {
            let chunk_futures = chunks
                .into_iter()
                .zip(&amp;mut host_senders)
                .map(|(chunk, sender)| sender.send_data(chunk));
    
            join_all(chunk_futures)
                .await
                .into_iter()
                .collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;()
                .unwrap();
        });
    }
<span class="boring">}
</span></code></pre></pre>
<p>But now he gets this error (<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=fd22ae9a8a7ec68cb73b2a10ecd702f4">playground</a>):</p>
<pre><code>error[E0382]: use of moved value: `host_senders`
  --&gt; src/lib.rs:15:33
   |
12 |       let mut host_senders: Vec&lt;hyper::body::Sender&gt; = vec![];
   |           ---------------- move occurs because `host_senders` has type `Vec&lt;hyper::body::Sender&gt;`, which does not implement the `Copy` trait
...
15 |           tokio::spawn(async move {
   |  _________________________________^
16 | |             let chunk_futures = chunks
17 | |                 .into_iter()
18 | |                 .zip(&amp;mut host_senders)
   | |                           ------------ use occurs due to use in generator
...  |
24 | |                 .collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;().unwrap();
25 | |         });
   | |_________^ value moved here, in previous iteration of loop
</code></pre>
<p>He removes the <code>move</code> keyword from <code>async move</code>, but then he sees:</p>
<pre><code>error[E0373]: async block may outlive the current function, but it borrows `host_senders`, which is owned by the current function
  --&gt; src/lib.rs:15:28
   |
15 |           tokio::spawn(async {
   |  ____________________________^
16 | |             let chunk_futures = chunks
17 | |                 .into_iter()
18 | |                 .zip(&amp;mut host_senders)
   | |                           ------------ `host_senders` is borrowed here
...  |
24 | |                 .collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;().unwrap();
25 | |         });
   | |_________^ may outlive borrowed value `host_senders`
   |
   = note: async blocks are not executed immediately and must either take a reference or ownership of outside variables they use
help: to force the async block to take ownership of `host_senders` (and any other referenced variables), use the `move` keyword
   |
15 |         tokio::spawn(async move {
16 |             let chunk_futures = chunks
17 |                 .into_iter()
18 |                 .zip(&amp;mut host_senders)
19 |                 .map(|(chunk, sender)| sender.send_data(chunk));
20 |     
 ...

error[E0499]: cannot borrow `host_senders` as mutable more than once at a time
  --&gt; src/lib.rs:15:28
   |
15 |            tokio::spawn(async {
   |   ______________________-_____^
   |  |______________________|
   | ||
16 | ||             let chunk_futures = chunks
17 | ||                 .into_iter()
18 | ||                 .zip(&amp;mut host_senders)
   | ||                           ------------ borrows occur due to use of `host_senders` in generator
...  ||
24 | ||                 .collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;().unwrap();
25 | ||         });
   | ||         ^
   | ||_________|
   | |__________`host_senders` was mutably borrowed here in the previous iteration of the loop
   |            argument requires that `host_senders` is borrowed for `'static`
</code></pre>
<p>At this point, he gives up and leaves a <code>// TODO</code> comment:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// TODO: This loop should be able to execute in parallel,
// but I can't figure out how to make it work. -Alan
while let Some(chunks) = shards.next().await {
    ...
}
<span class="boring">}
</span></code></pre></pre>
<p><em>Editorial comment:</em> In this case, the channel to which he is sending the data can only receive data from a single sender at a time (it has an <code>&amp;mut self</code>). Rust is potentially saving Alan from a nasty data race here. He could have used a mutex around the senders, but he would still hit issues trying to spawn parallel threads because he lacks an API that lets him borrow from the stack.</p>
<h2 id="implementing-a-stream"><a class="header" href="#implementing-a-stream">Implementing a stream</a></h2>
<ul>
<li>As DistriData development continues, Alan finds that </li>
</ul>
<h2 id="deadlock-from-nested-awaits"><a class="header" href="#deadlock-from-nested-awaits">Deadlock from nested awaits</a></h2>
<ul>
<li>XXX Adapt <a href="../submitted_stories/status_quo/aws_engineer/solving_a_deadlock.html">this story</a></li>
</ul>
<h2 id="slowdown-from-missing-waker"><a class="header" href="#slowdown-from-missing-waker">Slowdown from missing waker</a></h2>
<h2 id="packets-arriving-quickly-lead-to-surprising-problems"><a class="header" href="#packets-arriving-quickly-lead-to-surprising-problems">Packets arriving quickly lead to surprising problems</a></h2>
<ul>
<li>XXX Adapt stories from Fuchsia engineers about cancellation, select, etc</li>
<li>Talk about eventually arriving at standard patterns ..?</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../vision/status_quo/problems/testing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../vision/status_quo/slow.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../vision/status_quo/problems/testing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../vision/status_quo/slow.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../../mermaid.min.js"></script>
        <script type="text/javascript" src="../../mermaid-init.js"></script>
    </body>
</html>
